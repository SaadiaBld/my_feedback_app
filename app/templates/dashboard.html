<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Leroy Merlin Trustpilot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <style>
    .kpi-box {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      height: 100%;
    }
    .kpi-label {
      font-size: 1rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }
    .kpi-value {
      font-size: 2.2rem;
      font-weight: bold;
      color: #212529;
      margin-bottom: 0.25rem;
    }
    .kpi-delta {
      font-size: 0.85rem;
      font-weight: 500;
    }
    .kpi-delta.positive {
      color: #198754;
    }
    .kpi-delta.negative {
      color: #dc3545;
    }
    .chart-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
    }
    .truncate-text {
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <h2 class="mb-4">Leroy Merlin Trustpilot</h2>

  <!-- SÉLECTEURS DE DATE -->
  <div class="row mb-4">
    <div class="col-md-4">
      <label for="startDate">Date début (lundi) :</label>
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-md-4">
      <label for="endDate">Date fin (dimanche) :</label>
      <input type="date" id="endDate" class="form-control">
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button class="btn btn-primary w-100" onclick="loadDashboardData()">Mettre à jour</button>
    </div>
  </div>

  <!-- KPI -->
  <div class="row mb-4" id="kpiContainer"></div>

  <!-- CHARTS -->
  <div class="row mb-4">
    <div class="col-md-8 chart-container">
      <h6>Évolution de la satisfaction globale</h6>
      <canvas id="satisfactionTrendChart"></canvas>
    </div>
    <div class="col-md-4 chart-container">
      <h6>Répartition des thèmes</h6>
      <canvas id="themeDistributionChart"></canvas>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-12 chart-container">
      <h6>Satisfaction par thème</h6>
      <canvas id="themeSentimentChart"></canvas>
    </div>
  </div>

  <!-- TABLEAU DES VERBATIMS -->
  <div class="row mb-4">
    <div class="col-md-12 chart-container">
      <h6>Verbatims analysés (IA)</h6>
      <table id="verbatimsTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Date</th>
            <th>Contenu</th>
            <th>Thèmes détectés (avec score)</th>
            <th>Note client</th>
            <th>Score IA</th>
            <th>Auteur</th>
            <th style="display:none;">Thèmes (filtre)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>Filtrer...</th>
            <th>Filtrer...</th>
            <th>Filtrer...</th>
            <th>Filtrer...</th>
            <th>Filtrer...</th>
            <th>Filtrer...</th>
            <th style="display:none;">Filtrer...</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script>
const API_BASE = "{{ api_base_url }}";
const JWT_TOKEN = "{{ jwt_token }}"; // Récupérer le token JWT
let trendChart, themeChart, sentimentChart;

const doughnutColors = [
  "#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3",
  "#a6d854", "#ffd92f", "#e5c494", "#b3b3b3"
];

function isMonday(date) {
  return new Date(date).getDay() === 1;
}
function isSunday(date) {
  return new Date(date).getDay() === 0;
}

async function fetchData(url) {
  const headers = {
    'Authorization': `Bearer ${JWT_TOKEN}`
  };
  const response = await fetch(url, { headers });
  if (!response.ok) {
    if (response.status === 401) {
      alert("Session expirée ou non autorisée. Veuillez vous reconnecter.");
      window.location.href = "/"; // Rediriger vers la page de connexion
    } else {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
  }
  return response.json();
}

async function loadDashboardData() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  console.log("Dates sélectionnées: ", start, end);
  if (!start || !end || !isMonday(start) || !isSunday(end)) {
    alert("Veuillez choisir un lundi comme début et un dimanche comme fin.");
    return;
  }

  try {
    const kpi = await fetchData(`${API_BASE}/api/dashboard/kpis?start_date=${start}&end_date=${end}`);
    const themes = await fetchData(`${API_BASE}/api/dashboard/themes?start_date=${start}&end_date=${end}`);
    const trend = await fetchData(`${API_BASE}/api/dashboard/trend?start_date=${start}&end_date=${end}`);
    const dist = await fetchData(`${API_BASE}/api/dashboard/themes-distribution?start_date=${start}&end_date=${end}`);
    const sentiments = await fetchData(`${API_BASE}/api/dashboard/themes-satisfaction-breakdown?start_date=${start}&end_date=${end}`);
    const count = await fetchData(`${API_BASE}/api/dashboard/themes-satisfaction-count?start_date=${start}&end_date=${end}`);

    const startDate = new Date(start);
    const endDate = new Date(end);
    const diffTime = Math.abs(endDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    let delta_reviews_text = "";
    let delta_avg_rating_text = "";

    if (diffDays === 6) {
        let delta_reviews_val = kpi.delta_reviews;
        let delta_avg_rating_val = kpi.delta_avg_rating;

        let delta_reviews_class = delta_reviews_val >= 0 ? 'positive' : 'negative';
        let delta_avg_rating_class = delta_avg_rating_val >= 0 ? 'positive' : 'negative';

        let delta_reviews_sign = delta_reviews_val > 0 ? '+' : '';
        let delta_avg_rating_sign = delta_avg_rating_val > 0 ? '+' : '';

        delta_reviews_text = `<div class="kpi-delta ${delta_reviews_class}">${delta_reviews_sign}${delta_reviews_val} vs semaine précédente</div>`;
        delta_avg_rating_text = `<div class="kpi-delta ${delta_avg_rating_class}">${delta_avg_rating_sign}${delta_avg_rating_val.toFixed(2)} vs semaine précédente</div>`;
    }

    document.getElementById("kpiContainer").innerHTML = `
      <div class="col-md-3"><div class="kpi-box"><div class="kpi-label">Total Avis Client</div><div class="kpi-value">${kpi.current_reviews}</div>${delta_reviews_text}</div></div>
      <div class="col-md-3"><div class="kpi-box"><div class="kpi-label">Score Moyen</div><div class="kpi-value">${kpi.current_avg_rating.toFixed(2)} / 5</div>${delta_avg_rating_text}</div></div>
      <div class="col-md-3"><div class="kpi-box"><div class="kpi-label">Top Satisfaction</div><div class="kpi-value">${themes.top_satisfaction}</div></div></div>
      <div class="col-md-3"><div class="kpi-box"><div class="kpi-label">Top Irritant</div><div class="kpi-value">${themes.top_irritant}</div></div></div>
    `;

    // Satisfaction globale
    const labels = trend.map(t => t.week);
    const values = trend.map(t => t.avg_score);
    if (!trendChart) {
      trendChart = new Chart(document.getElementById("satisfactionTrendChart"), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Satisfaction moyenne', data: values, borderColor: '#56B4E9', backgroundColor: '#56B4E9', tension: 0.3,  // facultatif : ajoute un lissage doux
            pointRadius: 4,
            fill: false}] }
        });
    } else {
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = values;
      trendChart.update();
    }

    // Répartition thèmes
    const distLabels = dist.map(t => t.theme);
    const distData = dist.map(t => t.count);
    if (!themeChart) {
      themeChart = new Chart(document.getElementById("themeDistributionChart"), {
        type: 'doughnut',
        data: { labels: distLabels, datasets: [{ data: distData, backgroundColor: doughnutColors }] }
      });
    } else {
      themeChart.data.labels = distLabels;
      themeChart.data.datasets[0].data = distData;
      themeChart.update();
    }

    // Satisfaction par thème
    const keys = Object.keys(sentiments);
    const pos = keys.map(k => sentiments[k].Positif);
    const neu = keys.map(k => sentiments[k].Neutre);
    const neg = keys.map(k => sentiments[k].Négatif);
    if (!sentimentChart) {
      sentimentChart = new Chart(document.getElementById("themeSentimentChart"), {
        type: 'bar',
        data: {
          labels: keys,
          datasets: [
          {
            label: 'Positif',
            data: pos,
            backgroundColor: '#1b9e77',
            stack: 'stack1'
          },
          {
            label: 'Neutre',
            data: neu,
            backgroundColor: '#7570b3',
            stack: 'stack1'
          },
          {
            label: 'Négatif',
            data: neg,
            backgroundColor: '#d95f02',
            stack: 'stack1'
          }
        ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
        }
      });
    } else {
      sentimentChart.data.labels = keys;
      sentimentChart.data.datasets[0].data = pos;
      sentimentChart.data.datasets[1].data = neu;
      sentimentChart.data.datasets[2].data = neg;
      sentimentChart.update();
    }

    renderVerbatimsTable(count);
  } catch (err) {
    alert("Erreur de chargement des données");
    console.error(err);
  }
}

function renderVerbatimsTable(data) {
  // If the DataTable instance already exists, just destroy it, keeping the HTML
  if ($.fn.dataTable.isDataTable("#verbatimsTable")) {
    $('#verbatimsTable').DataTable().destroy();
  }

  const tbody = $("#verbatimsTable tbody");
  tbody.empty(); // Clear the table body manually before adding new rows

  data.forEach(row => {
    // Extract theme labels for the hidden filter column
    const cleanThemes = row.themes_score ? row.themes_score.split(',').map(t => t.split(':')[0].trim()).join(', ') : '';

    // Create a "Voir plus" preview for long content, ensuring quotes and newlines in content are handled
    const contentPreview = row.contenu && row.contenu.length > 180 
           ? row.contenu.substring(0, 180) + `... <span style="color:blue;cursor:pointer" onclick="alert('${row.contenu.replace(/'/g, "'").replace(/\n/g, "\n")}')">Voir plus</span>`
           : row.contenu;

    tbody.append(`
      <tr>
        <td>${row.date_publication || "-"}</td>
        <td>${contentPreview || "-"}</td>
        <td>${row.themes_score || "-"}</td>
        <td>${row.note_client || "-"}</td>
        <td>${row.score_IA || "-"}</td>
        <td>${row.auteur || "-"}</td>
        <td style="display:none;">${cleanThemes}</td> 
      </tr>
    `);
  });

  // Re-initialize the DataTable on the now-populated table
  $('#verbatimsTable').DataTable({
    dom: 'Bfrtip',
    buttons: ['csv', 'print'],
    scrollX: true,
    order: [[0, "desc"]],
    scrollCollapse: true,
    paging: true,
    initComplete: function () {
      this.api().columns().every(function () {
        const column = this;
        const footer = $(column.footer()).empty();
        // Add filtering inputs to all columns except the hidden one
        if (column.index() !== 6) { 
          const input = $('<input type="text" placeholder="Filtrer..." />')
            .appendTo(footer)
            .on('keyup change clear', () => {
              if (column.search() !== input.val()) {
                column.search(input.val()).draw();
              }
            });
        }
      });
    },
    columnDefs: [{ targets: [6], visible: false }] // Keep the theme filter column hidden
  });
}

window.onload = function () {
  const today = new Date();
  const monday = new Date(today.setDate(today.getDay() === 0 ? today.getDate() - 6 : today.getDate() - today.getDay() + 1));
  const sunday = new Date(today.setDate(monday.getDate() + 6));
  document.getElementById("startDate").value = monday.toISOString().split("T")[0];
  document.getElementById("endDate").value = sunday.toISOString().split("T")[0];
  if ("{{ is_testing }}" !== "True") {
    loadDashboardData();
  }
};
</script>
</body>
</html>